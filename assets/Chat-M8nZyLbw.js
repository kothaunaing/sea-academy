import{j as t,K,r as a,A as C,u as oe,aZ as Te,aJ as H,G as T,E as I,h as X,a as it,b as v,c as U,d as P,aN as ce,aF as he,aV as ke,aI as pe,aA as $e,aC as ot,aD as ct,az as ie,V as fe,W as xe,aT as lt,Y as Le,M as ut,F as _e,a_ as Me,aG as ae,s as Mt,S as Bt,U as Rt,aO as It,aP as Tt,aQ as Lt,aR as Ut,aS as Ot,aM as tt,X as Zt,aK as Pt,N as Vt,aE as Ht,aU as Gt,aB as st}from"./index-bRWVs4uH.js";import{P as ne}from"./ProfilePicture-zNPQiEmu.js";import{s as le}from"./sortByDateNewer-X-Bb2bKS.js";import{S as Ue}from"./SkeletonUser-DSnZzNbL.js";import{T as A}from"./Tooltip-nMSGeA9R.js";import{i as dt}from"./browser-image-compression-9kymdGFS.js";import{A as Wt,T as Yt}from"./Toolbar-tABwfNLo.js";import{I as W}from"./IconButton-G7F5S18q.js";import{c as ye}from"./createSvgIcon-WuW5eNVd.js";import{S as V}from"./Skeleton-gudHJ97I.js";import{E as mt}from"./EditSharp-_9lv0TsH.js";import{T as ht}from"./TextField-PX96Tbxo.js";import{S as qt}from"./SaveSharp-m03-ifTv.js";import{D as _t}from"./DeleteSharp-lqhLHkBh.js";import{A as Jt}from"./AddSharp-dC4SwfiP.js";import{g as Oe}from"./shortenText-S284lLsL.js";import{f as ge}from"./fixTime-t8Fgsaat.js";import{g as Ze}from"./getImage-SzyEh5nT.js";import{V as Qt}from"./VisibilitySharp-qlGiB9Hj.js";import{M as Kt,O as Xt}from"./OtherActions-oKlie0qg.js";import{I as es}from"./ImageViewer-MUpg3dPR.js";import{D as Pe}from"./Dialog-uv1MMool.js";import{L as ts}from"./LoadingScreen-s9LTCXQM.js";import{M as Ae}from"./EmptyComponent-B0v7Kud4.js";import{F as ss}from"./Fab-d6Kpdxwd.js";import{C as nt}from"./CloseSharp-aSUhFM6n.js";import{C as ns}from"./CollectionsSharp-2GT1TT6F.js";import"./Portal-VKXgkAI7.js";import"./useControlled-W8367X1y.js";import"./Modal-AoQCLYuG.js";import"./debounce-gOEKrWSg.js";import"./Stack-oEJLfJtD.js";const rs=ye(t.jsx("path",{d:"M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20z"}),"ArrowBack"),as=ye(t.jsx("path",{d:"m20 12-1.41-1.41L13 16.17V4h-2v12.17l-5.58-5.59L4 12l8 8z"}),"ArrowDownward"),is=ye(t.jsx("path",{d:"M10 9V5l-7 7 7 7v-4.1c5 0 8.5 1.6 11 5.1-1-5-4-10-11-11"}),"ReplySharp"),os=ye(t.jsx("path",{d:"M2.01 21 23 12 2.01 3 2 10l15 2-15 2z"}),"Send"),cs=({members:s})=>t.jsxs("div",{className:"p-2 grid gap-y-2 ",children:[t.jsx("p",{className:"text-lg font-bold",children:"Members"}),t.jsx(I,{className:"border rounded-md shadow-lg border-slate-200",children:s.sort((e,n)=>le(e,n,"joinedAt","newer")).map((e,n)=>t.jsx("div",{className:`p-2 flex gap-x-2 items-center border-t ${s.length===n&&"border-b"} ${n===0&&"border-t-0"}`,children:t.jsx(ls,{member:e})},e.uid+e.joinedAt))})]}),ls=K.memo(({member:s})=>{const{users:e}=a.useContext(C),[n,r]=a.useState(null),[o,l]=a.useState(!0),[u,i]=a.useState("offline"),[c,d]=a.useState(null),h=oe();Te(s.uid,i,d),H(s.uid,e,r,l);const g=()=>{h(`/app/profile/${n==null?void 0:n.uid}`)};return o?t.jsx(Ue,{}):t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"relative",children:[t.jsx(A,{arrow:!0,placement:"top",title:`View ${n==null?void 0:n.name}'s profile`,children:t.jsx("div",{onClick:g,className:"cursor-pointer",children:t.jsx(ne,{image:n==null?void 0:n.image,name:n==null?void 0:n.name})})}),t.jsx("div",{className:"size-[16px] bg-white rounded-full flex justify-center items-center absolute bottom-0 right-0",children:t.jsx("div",{className:` size-3 rounded-full ${u==="online"?"bg-green-500":"bg-gray-500"}`})})]}),t.jsxs("div",{className:"flex-1",children:[t.jsx(A,{arrow:!0,placement:"top",title:`View ${n==null?void 0:n.name}'s profile`,children:t.jsxs(T,{onClick:g,sx:{cursor:"pointer"},variant:"h6",fontSize:"0.9rem",children:[n==null?void 0:n.name," ",n!=null&&n.isAdmin?t.jsx(T,{variant:"caption",children:"(admin)"}):""]})}),t.jsx("p",{className:`text-sm ${u==="online"?"text-blue-500":"text-gray-500"}`,children:u==="online"?"Online":c})]})]})}),pt=K.memo(({pageName:s,setSubPage:e,currentChat:n,infoPage:r,memberCounts:o,onlineUsers:l})=>{var d;const u=oe(),i=X(),{mode:c}=i.palette;return t.jsx(Wt,{sx:{backgroundColor:c==="dark"?"background.default":"white",color:"text.primary"},children:t.jsxs(Yt,{className:`h-[70px] z-30 p-2 min-h-10 pb-2 flex items-center justify-between gap-x-1 ${c==="dark"?"border-slate-700":"border-slate-200"} border-b `,children:[t.jsxs("div",{className:"flex items-center gap-x-1",children:[t.jsx("div",{children:t.jsx(A,{title:"Navigate up",arrow:!0,children:t.jsx(W,{onClick:()=>{r?e(s):u("/app/chatroom")},children:t.jsx(rs,{})})})}),t.jsxs("div",{onClick:()=>e(s),className:"cursor-pointer",children:[t.jsx(T,{variant:"h6",fontSize:"1.1rem",children:n.name}),t.jsxs("div",{className:"flex items-center",children:[o?t.jsxs("p",{className:"text-sm ",children:[o," ",o<=1?"member":"members"]}):t.jsx(V,{height:40,width:100}),l?t.jsxs(T,{variant:"caption",children:[", "," ",l," online"]}):t.jsx(V,{height:40,width:60})]})]})]}),t.jsx("button",{onClick:()=>e(s),children:t.jsx("img",{src:((d=n==null?void 0:n.image)==null?void 0:d.URL)||"images/sea-logo.jpg",alt:"group-image",className:"size-12 rounded-full object-center object-cover "})})]})})}),us=K.memo(({setSubPage:s,currentChat:e,memberCounts:n,setMemberCounts:r,members:o,setMembers:l,onlineUsers:u})=>{var F;const{chatId:i}=it(),{users:c,userData:d}=a.useContext(C);X().palette;const g=v(P,"chats",i),[y,j]=a.useState(""),[D,S]=a.useState(null),w=v(P,"chats",i),b=U(w,"members");a.useEffect(()=>{j(e.name)},[e]);const k=_=>{let p=!1;return o.forEach(z=>{z.uid===_&&(p=!0)}),p},$=async _=>{let p=!1;const z=fe(b,lt("uid","==",_),xe(1));return console.log("Checking if a member..."),p=!(await Le(z)).empty,p};a.useEffect(()=>ce(b,L=>{L.empty||((async()=>await ut(b,r))(),l(L.docs.map(O=>({...O.data(),id:O.id}))))}),[]);const E=async _=>{try{const p=v(b,_);await $(_)||await ke(p,{uid:_,joinedAt:he()})}catch(p){console.log(p.message)}},M=async _=>{try{const p=v(b,_);await pe(p)}catch(p){console.log(p.message)}},Y=async()=>{if(!D)return;const _=`chats/${e.id}/groupImage-${D.name}`,p=$e(storage,_),z=await dt(D,{maxSizeMB:.5,maxWidthOrHeight:1280,useWebWorker:!0}),L=await ot(p,z),q=await ct(L.ref),O={name:D.name,path:_,URL:q,size:z.size};await ie(g,{image:O})},ee=async()=>{y.trim()&&await ie(g,{name:y})};if(a.useEffect(()=>{Y()},[D]),a.useEffect(()=>{scrollTo({top:0})},[]),e)return t.jsxs("div",{className:"",children:[t.jsx(pt,{pageName:"chat",infoPage:!0,setSubPage:s,currentChat:e,memberCounts:n,onlineUsers:u}),(d==null?void 0:d.isAdmin)&&t.jsxs(I,{className:"p-2 m-1 mt-4 shadow-md border rounded-md border-slate-200",children:[t.jsx("input",{id:"imageInput",className:"hidden",type:"file",accept:"image/*",onChange:_=>S(_.target.files[0])}),t.jsxs("div",{className:"relative size-24",children:[t.jsx("img",{src:((F=e==null?void 0:e.image)==null?void 0:F.URL)||"images/sea-logo.jpg",className:"size-24 rounded-full object-cover object-center bg-cover"}),t.jsx("label",{htmlFor:"imageInput",className:" p-1 size-7 rounded-full absolute -bottom-1 -right-1 cursor-pointer ",children:t.jsx(mt,{fontSize:"15px"})})]}),t.jsxs("div",{className:"mt-2 ",children:[t.jsx("p",{children:"Group Name"}),t.jsxs("div",{className:"flex gap-x-2 items-center",children:[t.jsx(ht,{size:"small",value:y,onChange:_=>j(_.target.value),placeholder:"Enter group name..."}),t.jsx(W,{size:"small",onClick:ee,children:t.jsx(qt,{fontSize:"18px"})})]})]})]}),o&&t.jsx(cs,{members:o}),(d==null?void 0:d.isAdmin)&&t.jsxs("div",{className:"p-2 grid gap-y-2 ",children:[t.jsx("p",{className:"text-lg font-bold",children:"Manage Members"}),t.jsx(I,{className:"border rounded-md shadow-lg border-slate-200",children:c.sort((_,p)=>le(_,p,"createdAt","newer")).map((_,p)=>t.jsx(ds,{user:_,i:p,members:o,addMember:E,removeMember:M,isAMember:k},_.name+" "+_.image+p))})]})]})}),ds=K.memo(({user:s,i:e,members:n,isAMember:r,removeMember:o,addMember:l})=>{const[u,i]=a.useState("offline"),[c,d]=a.useState(null),h=oe();Te(s.uid,i,d);const g=()=>{h(`/app/profile/${s==null?void 0:s.uid}`)};return t.jsxs("div",{className:`p-2 flex justify-between gap-x-2 items-center border-t border-slate-200 ${(n==null?void 0:n.length)===e&&"border-b"} ${e===0&&"border-t-0"} `,children:[t.jsxs("div",{className:"flex gap-x-2 items-center",children:[t.jsxs("div",{className:"relative",children:[t.jsx(A,{arrow:!0,placement:"top",title:`View ${s==null?void 0:s.name}'s profile`,children:t.jsx("div",{onClick:g,className:"cursor-pointer",children:t.jsx(ne,{image:s==null?void 0:s.image,name:s==null?void 0:s.name})})}),t.jsx("div",{className:"size-[16px] bg-white rounded-full flex justify-center items-center absolute bottom-0 right-0",children:t.jsx("div",{className:` size-3 rounded-full ${u==="online"?"bg-green-500":"bg-gray-500"}`})})]}),t.jsxs("div",{className:"flex-1",children:[t.jsx(A,{arrow:!0,placement:"top",title:`View ${s==null?void 0:s.name}'s profile`,children:t.jsx(T,{onClick:g,sx:{cursor:"pointer"},variant:"h6",fontSize:"0.9rem",children:s==null?void 0:s.name})}),t.jsx("p",{className:`text-sm ${u==="online"?"text-blue-500":"text-gray-500"}`,children:u==="online"?"Online":c})]})]}),t.jsx("div",{children:r(s.uid)?!s.isAdmin&&t.jsx(A,{title:`Remove ${s.name}`,arrow:!0,placement:"left",children:t.jsx(W,{size:"small",onClick:()=>o(s.uid),children:t.jsx(_t,{})})}):t.jsx(A,{title:`Add ${s.name}`,arrow:!0,placement:"left",children:t.jsx(W,{size:"small",onClick:()=>l(s.uid),children:t.jsx(Jt,{})})})})]})}),ms=[{name:"like",image:"facebookLike"},{name:"love",image:"facebookLove"},{name:"haha",image:"facebookHaha"},{name:"wow",image:"facebookWow"},{name:"sad",image:"facebookSad"},{name:"angry",image:"facebookAngry"}],hs=({chatId:s,message:e,setReactedUsers:n})=>{a.useState(!1);const[r,o]=a.useState([]),l=U(v(U(v(P,"chats",s),"messages"),e.id),"reactedBy"),{userId:u}=a.useContext(C),i=X(),{mode:c}=i.palette,d=()=>ce(l,D=>{if(D.empty)o([]);else{const S=D.docs.map(w=>w.data());o(S)}});a.useEffect(()=>{const j=d();return()=>{j&&j()}},[]);const h=async()=>{const j=v(l,u);await pe(j)},g=j=>{let D=!1;return r.forEach(S=>{S.reactionType===j&&(D=!0)}),D},y=ms.filter(j=>g(j.name));if(r.length!==0)return t.jsx("div",{children:t.jsx(A,{arrow:!0,title:r.length===1?"1 reaction":`${r.length} reactions`,children:t.jsxs("button",{onClick:()=>n({reactedBy:r,removeReaction:h}),className:`mt-2 border ${c==="light"?"border-slate-200 ":"border-slate-700"}  p-1 rounded-lg flex justify-center items-center text-sm`,children:[y.map((j,D)=>t.jsx("img",{className:"w-4 ml-[-3px]",src:Ze(j.image)},`reaction-${j.name}-${D}`)),t.jsx("span",{className:"ml-1",children:r.length})]})})})};function Be(s){return new Date(s).toLocaleTimeString([],{hour:"numeric",minute:"numeric",hour12:!0})}const _s=/[\0-\uD7FF\uE000-\uFFFF]|[\uD800-\uDBFF][\uDC00-\uDFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF]/,ps=/[\0-\x1F\x7F-\x9F]/,fs=/[!-#%-\*,-\/:;\?@\[-\]_\{\}\xA1\xA7\xAB\xB6\xB7\xBB\xBF\u037E\u0387\u055A-\u055F\u0589\u058A\u05BE\u05C0\u05C3\u05C6\u05F3\u05F4\u0609\u060A\u060C\u060D\u061B\u061D-\u061F\u066A-\u066D\u06D4\u0700-\u070D\u07F7-\u07F9\u0830-\u083E\u085E\u0964\u0965\u0970\u09FD\u0A76\u0AF0\u0C77\u0C84\u0DF4\u0E4F\u0E5A\u0E5B\u0F04-\u0F12\u0F14\u0F3A-\u0F3D\u0F85\u0FD0-\u0FD4\u0FD9\u0FDA\u104A-\u104F\u10FB\u1360-\u1368\u1400\u166E\u169B\u169C\u16EB-\u16ED\u1735\u1736\u17D4-\u17D6\u17D8-\u17DA\u1800-\u180A\u1944\u1945\u1A1E\u1A1F\u1AA0-\u1AA6\u1AA8-\u1AAD\u1B5A-\u1B60\u1B7D\u1B7E\u1BFC-\u1BFF\u1C3B-\u1C3F\u1C7E\u1C7F\u1CC0-\u1CC7\u1CD3\u2010-\u2027\u2030-\u2043\u2045-\u2051\u2053-\u205E\u207D\u207E\u208D\u208E\u2308-\u230B\u2329\u232A\u2768-\u2775\u27C5\u27C6\u27E6-\u27EF\u2983-\u2998\u29D8-\u29DB\u29FC\u29FD\u2CF9-\u2CFC\u2CFE\u2CFF\u2D70\u2E00-\u2E2E\u2E30-\u2E4F\u2E52-\u2E5D\u3001-\u3003\u3008-\u3011\u3014-\u301F\u3030\u303D\u30A0\u30FB\uA4FE\uA4FF\uA60D-\uA60F\uA673\uA67E\uA6F2-\uA6F7\uA874-\uA877\uA8CE\uA8CF\uA8F8-\uA8FA\uA8FC\uA92E\uA92F\uA95F\uA9C1-\uA9CD\uA9DE\uA9DF\uAA5C-\uAA5F\uAADE\uAADF\uAAF0\uAAF1\uABEB\uFD3E\uFD3F\uFE10-\uFE19\uFE30-\uFE52\uFE54-\uFE61\uFE63\uFE68\uFE6A\uFE6B\uFF01-\uFF03\uFF05-\uFF0A\uFF0C-\uFF0F\uFF1A\uFF1B\uFF1F\uFF20\uFF3B-\uFF3D\uFF3F\uFF5B\uFF5D\uFF5F-\uFF65]|\uD800[\uDD00-\uDD02\uDF9F\uDFD0]|\uD801\uDD6F|\uD802[\uDC57\uDD1F\uDD3F\uDE50-\uDE58\uDE7F\uDEF0-\uDEF6\uDF39-\uDF3F\uDF99-\uDF9C]|\uD803[\uDEAD\uDF55-\uDF59\uDF86-\uDF89]|\uD804[\uDC47-\uDC4D\uDCBB\uDCBC\uDCBE-\uDCC1\uDD40-\uDD43\uDD74\uDD75\uDDC5-\uDDC8\uDDCD\uDDDB\uDDDD-\uDDDF\uDE38-\uDE3D\uDEA9]|\uD805[\uDC4B-\uDC4F\uDC5A\uDC5B\uDC5D\uDCC6\uDDC1-\uDDD7\uDE41-\uDE43\uDE60-\uDE6C\uDEB9\uDF3C-\uDF3E]|\uD806[\uDC3B\uDD44-\uDD46\uDDE2\uDE3F-\uDE46\uDE9A-\uDE9C\uDE9E-\uDEA2\uDF00-\uDF09]|\uD807[\uDC41-\uDC45\uDC70\uDC71\uDEF7\uDEF8\uDF43-\uDF4F\uDFFF]|\uD809[\uDC70-\uDC74]|\uD80B[\uDFF1\uDFF2]|\uD81A[\uDE6E\uDE6F\uDEF5\uDF37-\uDF3B\uDF44]|\uD81B[\uDE97-\uDE9A\uDFE2]|\uD82F\uDC9F|\uD836[\uDE87-\uDE8B]|\uD83A[\uDD5E\uDD5F]/,xs=/[ \xA0\u1680\u2000-\u200A\u2028\u2029\u202F\u205F\u3000]/;function gs(s){const e={};s=s||{},e.src_Any=_s.source,e.src_Cc=ps.source,e.src_Z=xs.source,e.src_P=fs.source,e.src_ZPCc=[e.src_Z,e.src_P,e.src_Cc].join("|"),e.src_ZCc=[e.src_Z,e.src_Cc].join("|");const n="[><｜]";return e.src_pseudo_letter="(?:(?!"+n+"|"+e.src_ZPCc+")"+e.src_Any+")",e.src_ip4="(?:(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)",e.src_auth="(?:(?:(?!"+e.src_ZCc+"|[@/\\[\\]()]).)+@)?",e.src_port="(?::(?:6(?:[0-4]\\d{3}|5(?:[0-4]\\d{2}|5(?:[0-2]\\d|3[0-5])))|[1-5]?\\d{1,4}))?",e.src_host_terminator="(?=$|"+n+"|"+e.src_ZPCc+")(?!"+(s["---"]?"-(?!--)|":"-|")+"_|:\\d|\\.-|\\.(?!$|"+e.src_ZPCc+"))",e.src_path="(?:[/?#](?:(?!"+e.src_ZCc+"|"+n+`|[()[\\]{}.,"'?!\\-;]).|\\[(?:(?!`+e.src_ZCc+"|\\]).)*\\]|\\((?:(?!"+e.src_ZCc+"|[)]).)*\\)|\\{(?:(?!"+e.src_ZCc+'|[}]).)*\\}|\\"(?:(?!'+e.src_ZCc+`|["]).)+\\"|\\'(?:(?!`+e.src_ZCc+"|[']).)+\\'|\\'(?="+e.src_pseudo_letter+"|[-])|\\.{2,}[a-zA-Z0-9%/&]|\\.(?!"+e.src_ZCc+"|[.]|$)|"+(s["---"]?"\\-(?!--(?:[^-]|$))(?:-*)|":"\\-+|")+",(?!"+e.src_ZCc+"|$)|;(?!"+e.src_ZCc+"|$)|\\!+(?!"+e.src_ZCc+"|[!]|$)|\\?(?!"+e.src_ZCc+"|[?]|$))+|\\/)?",e.src_email_name='[\\-;:&=\\+\\$,\\.a-zA-Z0-9_][\\-;:&=\\+\\$,\\"\\.a-zA-Z0-9_]*',e.src_xn="xn--[a-z0-9\\-]{1,59}",e.src_domain_root="(?:"+e.src_xn+"|"+e.src_pseudo_letter+"{1,63})",e.src_domain="(?:"+e.src_xn+"|(?:"+e.src_pseudo_letter+")|(?:"+e.src_pseudo_letter+"(?:-|"+e.src_pseudo_letter+"){0,61}"+e.src_pseudo_letter+"))",e.src_host="(?:(?:(?:(?:"+e.src_domain+")\\.)*"+e.src_domain+"))",e.tpl_host_fuzzy="(?:"+e.src_ip4+"|(?:(?:(?:"+e.src_domain+")\\.)+(?:%TLDS%)))",e.tpl_host_no_ip_fuzzy="(?:(?:(?:"+e.src_domain+")\\.)+(?:%TLDS%))",e.src_host_strict=e.src_host+e.src_host_terminator,e.tpl_host_fuzzy_strict=e.tpl_host_fuzzy+e.src_host_terminator,e.src_host_port_strict=e.src_host+e.src_port+e.src_host_terminator,e.tpl_host_port_fuzzy_strict=e.tpl_host_fuzzy+e.src_port+e.src_host_terminator,e.tpl_host_port_no_ip_fuzzy_strict=e.tpl_host_no_ip_fuzzy+e.src_port+e.src_host_terminator,e.tpl_host_fuzzy_test="localhost|www\\.|\\.\\d{1,3}\\.|(?:\\.(?:%TLDS%)(?:"+e.src_ZPCc+"|>|$))",e.tpl_email_fuzzy="(^|"+n+'|"|\\(|'+e.src_ZCc+")("+e.src_email_name+"@"+e.tpl_host_fuzzy_strict+")",e.tpl_link_fuzzy="(^|(?![.:/\\-_@])(?:[$+<=>^`|｜]|"+e.src_ZPCc+"))((?![$+<=>^`|｜])"+e.tpl_host_port_fuzzy_strict+e.src_path+")",e.tpl_link_no_ip_fuzzy="(^|(?![.:/\\-_@])(?:[$+<=>^`|｜]|"+e.src_ZPCc+"))((?![$+<=>^`|｜])"+e.tpl_host_port_no_ip_fuzzy_strict+e.src_path+")",e}function Re(s){return Array.prototype.slice.call(arguments,1).forEach(function(n){n&&Object.keys(n).forEach(function(r){s[r]=n[r]})}),s}function De(s){return Object.prototype.toString.call(s)}function js(s){return De(s)==="[object String]"}function ys(s){return De(s)==="[object Object]"}function Ds(s){return De(s)==="[object RegExp]"}function rt(s){return De(s)==="[object Function]"}function bs(s){return s.replace(/[.?*+^$[\]\\(){}|-]/g,"\\$&")}const ft={fuzzyLink:!0,fuzzyEmail:!0,fuzzyIP:!1};function ws(s){return Object.keys(s||{}).reduce(function(e,n){return e||ft.hasOwnProperty(n)},!1)}const Fs={"http:":{validate:function(s,e,n){const r=s.slice(e);return n.re.http||(n.re.http=new RegExp("^\\/\\/"+n.re.src_auth+n.re.src_host_port_strict+n.re.src_path,"i")),n.re.http.test(r)?r.match(n.re.http)[0].length:0}},"https:":"http:","ftp:":"http:","//":{validate:function(s,e,n){const r=s.slice(e);return n.re.no_http||(n.re.no_http=new RegExp("^"+n.re.src_auth+"(?:localhost|(?:(?:"+n.re.src_domain+")\\.)+"+n.re.src_domain_root+")"+n.re.src_port+n.re.src_host_terminator+n.re.src_path,"i")),n.re.no_http.test(r)?e>=3&&s[e-3]===":"||e>=3&&s[e-3]==="/"?0:r.match(n.re.no_http)[0].length:0}},"mailto:":{validate:function(s,e,n){const r=s.slice(e);return n.re.mailto||(n.re.mailto=new RegExp("^"+n.re.src_email_name+"@"+n.re.src_host_strict,"i")),n.re.mailto.test(r)?r.match(n.re.mailto)[0].length:0}}},vs="a[cdefgilmnoqrstuwxz]|b[abdefghijmnorstvwyz]|c[acdfghiklmnoruvwxyz]|d[ejkmoz]|e[cegrstu]|f[ijkmor]|g[abdefghilmnpqrstuwy]|h[kmnrtu]|i[delmnoqrst]|j[emop]|k[eghimnprwyz]|l[abcikrstuvy]|m[acdeghklmnopqrstuvwxyz]|n[acefgilopruz]|om|p[aefghklmnrstwy]|qa|r[eosuw]|s[abcdeghijklmnortuvxyz]|t[cdfghjklmnortvwz]|u[agksyz]|v[aceginu]|w[fs]|y[et]|z[amw]",Cs="biz|com|edu|gov|net|org|pro|web|xxx|aero|asia|coop|info|museum|name|shop|рф".split("|");function Ss(s){s.__index__=-1,s.__text_cache__=""}function Es(s){return function(e,n){const r=e.slice(n);return s.test(r)?r.match(s)[0].length:0}}function at(){return function(s,e){e.normalize(s)}}function je(s){const e=s.re=gs(s.__opts__),n=s.__tlds__.slice();s.onCompile(),s.__tlds_replaced__||n.push(vs),n.push(e.src_xn),e.src_tlds=n.join("|");function r(i){return i.replace("%TLDS%",e.src_tlds)}e.email_fuzzy=RegExp(r(e.tpl_email_fuzzy),"i"),e.link_fuzzy=RegExp(r(e.tpl_link_fuzzy),"i"),e.link_no_ip_fuzzy=RegExp(r(e.tpl_link_no_ip_fuzzy),"i"),e.host_fuzzy_test=RegExp(r(e.tpl_host_fuzzy_test),"i");const o=[];s.__compiled__={};function l(i,c){throw new Error('(LinkifyIt) Invalid schema "'+i+'": '+c)}Object.keys(s.__schemas__).forEach(function(i){const c=s.__schemas__[i];if(c===null)return;const d={validate:null,link:null};if(s.__compiled__[i]=d,ys(c)){Ds(c.validate)?d.validate=Es(c.validate):rt(c.validate)?d.validate=c.validate:l(i,c),rt(c.normalize)?d.normalize=c.normalize:c.normalize?l(i,c):d.normalize=at();return}if(js(c)){o.push(i);return}l(i,c)}),o.forEach(function(i){s.__compiled__[s.__schemas__[i]]&&(s.__compiled__[i].validate=s.__compiled__[s.__schemas__[i]].validate,s.__compiled__[i].normalize=s.__compiled__[s.__schemas__[i]].normalize)}),s.__compiled__[""]={validate:null,normalize:at()};const u=Object.keys(s.__compiled__).filter(function(i){return i.length>0&&s.__compiled__[i]}).map(bs).join("|");s.re.schema_test=RegExp("(^|(?!_)(?:[><｜]|"+e.src_ZPCc+"))("+u+")","i"),s.re.schema_search=RegExp("(^|(?!_)(?:[><｜]|"+e.src_ZPCc+"))("+u+")","ig"),s.re.schema_at_start=RegExp("^"+s.re.schema_search.source,"i"),s.re.pretest=RegExp("("+s.re.schema_test.source+")|("+s.re.host_fuzzy_test.source+")|@","i"),Ss(s)}function zs(s,e){const n=s.__index__,r=s.__last_index__,o=s.__text_cache__.slice(n,r);this.schema=s.__schema__.toLowerCase(),this.index=n+e,this.lastIndex=r+e,this.raw=o,this.text=o,this.url=o}function Ie(s,e){const n=new zs(s,e);return s.__compiled__[n.schema].normalize(n,s),n}function R(s,e){if(!(this instanceof R))return new R(s,e);e||ws(s)&&(e=s,s={}),this.__opts__=Re({},ft,e),this.__index__=-1,this.__last_index__=-1,this.__schema__="",this.__text_cache__="",this.__schemas__=Re({},Fs,s),this.__compiled__={},this.__tlds__=Cs,this.__tlds_replaced__=!1,this.re={},je(this)}R.prototype.add=function(e,n){return this.__schemas__[e]=n,je(this),this};R.prototype.set=function(e){return this.__opts__=Re(this.__opts__,e),this};R.prototype.test=function(e){if(this.__text_cache__=e,this.__index__=-1,!e.length)return!1;let n,r,o,l,u,i,c,d,h;if(this.re.schema_test.test(e)){for(c=this.re.schema_search,c.lastIndex=0;(n=c.exec(e))!==null;)if(l=this.testSchemaAt(e,n[2],c.lastIndex),l){this.__schema__=n[2],this.__index__=n.index+n[1].length,this.__last_index__=n.index+n[0].length+l;break}}return this.__opts__.fuzzyLink&&this.__compiled__["http:"]&&(d=e.search(this.re.host_fuzzy_test),d>=0&&(this.__index__<0||d<this.__index__)&&(r=e.match(this.__opts__.fuzzyIP?this.re.link_fuzzy:this.re.link_no_ip_fuzzy))!==null&&(u=r.index+r[1].length,(this.__index__<0||u<this.__index__)&&(this.__schema__="",this.__index__=u,this.__last_index__=r.index+r[0].length))),this.__opts__.fuzzyEmail&&this.__compiled__["mailto:"]&&(h=e.indexOf("@"),h>=0&&(o=e.match(this.re.email_fuzzy))!==null&&(u=o.index+o[1].length,i=o.index+o[0].length,(this.__index__<0||u<this.__index__||u===this.__index__&&i>this.__last_index__)&&(this.__schema__="mailto:",this.__index__=u,this.__last_index__=i))),this.__index__>=0};R.prototype.pretest=function(e){return this.re.pretest.test(e)};R.prototype.testSchemaAt=function(e,n,r){return this.__compiled__[n.toLowerCase()]?this.__compiled__[n.toLowerCase()].validate(e,r,this):0};R.prototype.match=function(e){const n=[];let r=0;this.__index__>=0&&this.__text_cache__===e&&(n.push(Ie(this,r)),r=this.__last_index__);let o=r?e.slice(r):e;for(;this.test(o);)n.push(Ie(this,r)),o=o.slice(this.__last_index__),r+=this.__last_index__;return n.length?n:null};R.prototype.matchAtStart=function(e){if(this.__text_cache__=e,this.__index__=-1,!e.length)return null;const n=this.re.schema_at_start.exec(e);if(!n)return null;const r=this.testSchemaAt(e,n[2],n[0].length);return r?(this.__schema__=n[2],this.__index__=n.index+n[1].length,this.__last_index__=n.index+n[0].length+r,Ie(this,0)):null};R.prototype.tlds=function(e,n){return e=Array.isArray(e)?e:[e],n?(this.__tlds__=this.__tlds__.concat(e).sort().filter(function(r,o,l){return r!==l[o-1]}).reverse(),je(this),this):(this.__tlds__=e.slice(),this.__tlds_replaced__=!0,je(this),this)};R.prototype.normalize=function(e){e.schema||(e.url="http://"+e.url),e.schema==="mailto:"&&!/^mailto:/i.test(e.url)&&(e.url="mailto:"+e.url)};R.prototype.onCompile=function(){};const As=K.memo(({message:s,messages:e,deleteMessage:n,setMessage:r,setImageObject:o,setEditMessageObject:l,setViewingImage:u,setReplyMessage:i,chatId:c,messagesRef:d,messageIndex:h,viewingOldMessages:g,setSeenUsers:y,setMessageOption:j,setReactedUsers:D,index:S})=>{var re;const{userData:w,userId:b}=a.useContext(C),k=X(),{mode:$}=k.palette,E=b===s.senderId,M=(s==null?void 0:s.seenBy)&&s.seenBy.length>0,Y=a.useRef(!1),[ee,F]=a.useState(!1),_=G=>{F(G)},p={...s,index:h},z=E?{text:"Edit",icon:t.jsx(mt,{}),onClick:()=>{l(p),r(s.content),o(s==null?void 0:s.image),i(s==null?void 0:s.reply)}}:null,L=E||w!=null&&w.isAdmin?{text:"Delete",icon:t.jsx(_t,{}),onClick:()=>{n(s,h)}}:null,q=()=>{let G=!1;return((s==null?void 0:s.seenBy)||[]).forEach(te=>{b===te.uid&&(G=!0)}),G},O=()=>S>=e.length-5&&S<=e.length-1;return a.useEffect(()=>{s&&(async()=>{const J=v(d,s.id);if(!Y.current&&!q()&&!E&&O()&&!g)try{await ie(J,{seenBy:Me({uid:b,timestamp:new Date().getTime()})}),Y.current=!0}catch(te){console.error("Error marking message as seen: ",te)}})()},[]),t.jsxs(I,{onMouseEnter:()=>_(!0),onMouseLeave:()=>_(!1),className:`${$==="dark"?"hover:bg-slate-700 border-slate-700/50":"hover:bg-slate-100 border-slate-200"}  rounded-md flex mb-1 gap-x-2 pt-2 pb-2   ${E?"flex-row-reverse":""} `,children:[t.jsx(Ns,{senderId:s.senderId}),t.jsx("div",{className:"grid gap-y-1 whitespace-pre-wrap ",children:t.jsxs("div",{className:`flex  items-start gap-x-1 ${E?"flex-row-reverse justify-start":""}`,children:[t.jsx("div",{className:"relative",children:t.jsxs("div",{className:`min-w-[200px] max-w-[300px]  shadow-md border border-slate-300 ${E?"justify-start":"fdbg-white  "} grid min-w-20 break-words whitespace-pre-wrap text-wrap rounded-[10px] border-slate-200 p-3 pb-0 `,children:[t.jsx(ks,{senderId:s.senderId,isYourMessage:E}),(s==null?void 0:s.reply)&&t.jsx($s,{message:s,setViewingImage:u}),t.jsx(xt,{content:s.content,isYourMessage:E}),(s==null?void 0:s.image)&&t.jsx("img",{onClick:()=>{u(s.image)},className:"cursor-pointer mt-1 mb-1 rounded-md max-h-[200px] overflow-hidden  ",alt:s.image.name,src:s.image.URL}),t.jsx(hs,{chatId:c,message:s,setReactedUsers:D}),t.jsx("div",{className:`flex  ${E?"flex-row-reverse":""} gap-x-1 items-center mt-1`,children:t.jsxs("p",{className:`  mt-1 p-1 text-sm text-gray-400 text-sm flex gap-x-1 items-center ${E?"text-right":""}`,children:[s!=null&&s.editedTime?t.jsxs("span",{children:["edited ",Be(ge(s.editedTime))]}):t.jsx("span",{children:Be(ge(s.timestamp))}),M?t.jsx(A,{title:s.seenBy.length==1?"Seen by 1 user":"Seen by "+s.seenBy.length+" users",arrow:!0,children:t.jsx(_e,{size:"small",startIcon:t.jsx(Qt,{}),onClick:()=>{y(s.seenBy)},className:"flex gap-x-1 items-center",children:(re=s==null?void 0:s.seenBy)==null?void 0:re.length})}):""]})})]})}),ee&&t.jsx(A,{title:"More options",arrow:!0,children:t.jsx(W,{onClick:()=>j({...s,options:[z,L,{text:"Reply",icon:t.jsx(is,{}),onClick:()=>i(s)}]}),children:t.jsx(Kt,{})})})]})})]})}),xt=({content:s,isYourMessage:e=!1})=>{const n=new R;n.tlds("onion",!0),n.set({fuzzyLink:!0});const r=n.match(s),o=(l,u=30)=>l.length>u?l.slice(0,u)+"...":l;return r&&r.forEach(l=>{const u=l.url.startsWith("http")?l.url:`https://${l.url}`;s=s.replace(l.url,`<a href="${u}" style="text-decoration: underline; color: blue;" target="_blank" rel="noopener norefereer">${o(u)}<a>`)}),t.jsx("div",{className:"w-full max-w-full break-words  ",dangerouslySetInnerHTML:{__html:s}})},Ns=({senderId:s})=>{const{users:e}=a.useContext(C),[n,r]=a.useState(null),[o,l]=a.useState(!0);H(s,e,r,l);const[u,i]=a.useState("offline"),[c,d]=a.useState(null),h=oe();return Te(s,i,d),o?t.jsx(V,{variant:"circular",height:40,width:40}):t.jsxs("div",{className:"size-10  relative",children:[t.jsx(A,{placement:"top",arrow:!0,title:`View ${n==null?void 0:n.name}'s profile`,children:t.jsx("div",{className:"cursor-pointer",onClick:()=>h(`/app/profile/${n==null?void 0:n.uid}`),children:t.jsx(ne,{name:n&&n.name,image:n&&n.image})})}),t.jsx("div",{className:"size-[16px] bg-white rounded-full flex justify-center items-center absolute bottom-0 right-0",children:t.jsx("div",{className:` size-3 rounded-full ${u==="online"?"bg-green-500":"bg-gray-500"}`})})]})},ks=({senderId:s,isYourMessage:e})=>{const{users:n}=a.useContext(C),[r,o]=a.useState(null),[l,u]=a.useState(!0),i=oe();return H(s,n,o,u),l?t.jsx("div",{className:`-mt-3 ${e?"text-right":""}`,children:t.jsx(V,{height:40,width:120})}):t.jsx(A,{placement:"top",arrow:!0,title:`View ${r==null?void 0:r.name}'s profile`,children:t.jsx("p",{onClick:()=>i(`/app/profile/${r==null?void 0:r.uid}`),className:`cursor-pointer font-bold mb-2 ${e?"text-right":""} `,children:r!=null&&r.name?r.name:"Unknown User"})})},$s=({message:s,setViewingImage:e})=>{const{users:n}=a.useContext(C),{senderId:r,content:o,image:l}=s.reply,[u,i]=a.useState(!0),[c,d]=a.useState(!1),[h,g]=a.useState(null);return H(r,n,g,i),t.jsxs("div",{className:"mb-1 border-l-4 p-1 rounded-md border-l-green-500 ",children:[u?t.jsx(V,{width:120,height:40}):t.jsx("p",{className:"font-bold ",children:h==null?void 0:h.name}),o&&t.jsxs("p",{className:"w-full max-w-full break-words",children:[t.jsx(xt,{content:c?o:Oe(o,25)}),o.length>=25&&t.jsx("span",{onClick:()=>{d(!c)},className:"font-bold text-blue-400 cursor-pointer",children:c?" see less":" see more"})]}),l&&t.jsx("img",{onClick:()=>{e(l)},className:"cursor-pointer border mt-1 mb-1 rounded-md border-slate-200 overflow-hidden max-h-[200px]",alt:l.name,src:l.URL})]})},Ms=({setIsRulesOpen:s,isRulesOpen:e,rules:n=["ရိုသေလေးစားမှုရှိပါ - Group ထဲတွင် ရှိသောသူများအားလုံးကို လေးစားရမည်။ မသင့်တော်သော စကားလုံးများ၊ အခြားသူများကို ထိခိုက်စေနိုင်သော စကားလုံးများကို မပြောရ။","No spamming - တူညီသော မက်ဆေ့ချ်များ၊ လင့်ခ် (link) များနှင့်၊ အမြောက်အများသော emoji များ ပို့ခြင်းကို မပြုရ။","Privacy ရှိပါ - တစ်စုံတစ်ဦး၏ ကိုယ်ရေးကိုယ်တာ အချက်အလက်များကို ခွင့်ပြုချက်မရှိဘဲ မမျှဝေရ။ လူတိုင်း၏ ကိုယ်ရေးကိုယ်တာကို လေးစားပါ။","အထက်ပါ စည်းမျဉ်းစည်းကမ်းများ (rules) ထဲမှ တစ်ခုခုကို ချိုးဖောက်ပါက Group ထဲမှ ရက်အကန့်အသတ်ဖြင့် သော်လည်းကောင်း၊ ရာသတ်ပန် သော်လည်းကောင်း ထုတ်ပယ်မည် (သို့မဟုတ်) ထိုက်တန်သော အပြစ်တစ်ခုခုကို ခံယူရမည်။"]})=>t.jsx(Pe,{open:e,onClose:()=>s(!1),children:n?t.jsxs("div",{className:"p-2 max-h-[80%] overflow-auto",children:[t.jsx("p",{className:"font-bold mb-1",children:"Group Rules"}),n.map((r,o)=>t.jsxs("div",{className:"flex items-start  gap-x-1 mb-2",children:[t.jsx("p",{className:"size-10 items-center flex justify-center rounded-full ",children:o+1}),t.jsx("p",{className:"flex-1 text-sm",children:r})]},`${o}-${r}`))]}):t.jsx("div",{className:"p-2",children:"No rules"})}),Bs=({typingUsersRef:s,viewingOldMessages:e})=>{const{userId:n,openSnackbar:r}=a.useContext(C),[o,l]=a.useState([]),[u,i]=a.useState(!1),c=()=>{const d=window.scrollY,h=window.innerHeight,g=document.documentElement.scrollHeight;i(d+h>=g-350)};if(a.useEffect(()=>{const h=ce(s,y=>{console.log("fetching typing users...");const j=y.docs.map(D=>({uid:D.id,...D.data()}));l(j)},y=>{console.log("Error fetching typing users: ",y.message)});return()=>{h&&h()}},[]),a.useEffect(()=>{!e&&o.length!==0&&u&&ae()},[o,u]),a.useEffect(()=>(window.addEventListener("scroll",c),()=>{window.removeEventListener("scroll",c)}),[]),o.length>0)return t.jsx("div",{className:"",children:t.jsx("div",{className:"grid gap-y-1",children:o.sort((d,h)=>le(d,h,"timestamp","older")).map(d=>{const h=n===d.uid;return t.jsxs("div",{className:`flex mb-2 gap-x-2 ${h?"flex-row-reverse":""} `,children:[t.jsx(Rs,{typingUser:d}),t.jsxs("div",{className:"grid gap-y-1 whitespace-pre-wrap",children:[t.jsx(Is,{isYourMessage:h,typingUser:d}),t.jsx("div",{className:`flex items-start gap-x-1 ${h?"flex-row-reverse justify-start":""}`,children:t.jsxs("div",{children:[t.jsx(V,{height:40,width:150}),t.jsx(V,{sx:{mt:-1},height:30,width:100})]})})]})]},`typingUsers-${d.uid}`)})})})},Rs=({typingUser:s})=>{const{users:e}=a.useContext(C),[n,r]=a.useState(null),[o,l]=a.useState(!0);return H(s.uid,e,r,l),t.jsxs("div",{className:"size-10 relative",children:[o?t.jsx(V,{width:40,height:40}):t.jsx(ne,{name:n==null?void 0:n.name,image:n==null?void 0:n.image}),t.jsx("div",{className:"absolute bottom-0 right-0 size-3 rounded-full bg-green-500"})]})},Is=({typingUser:s,isYourMessage:e})=>{const{users:n}=a.useContext(C),[r,o]=a.useState(null),[l,u]=a.useState(!0);return H(s.uid,n,o,u),t.jsx(t.Fragment,{children:l?t.jsx(V,{height:40,width:120}):t.jsx("p",{className:`font-bold ${e?"text-right":"text-left"} `,children:r==null?void 0:r.name})})},Ts=["January","February","March","April","May","June","July","August","September","October","November","December"],Ls=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];function gt(s){const e=new Date(s),n=new Date,r=e.getFullYear(),o=e.getMonth(),l=e.getDate(),u=Ls[e.getDay()],i=n.getDay()===e.getDay()&&n.getMonth()===e.getMonth()&&n.getFullYear()===e.getFullYear(),c=!i&&e.getDay()===n.getDay()-1;return i?"Today":c?"Yesterday":`${u}, ${Ts[o]} ${l}, ${r}`}const Us=({seenUsers:s,setSeenUsers:e})=>{a.useContext(C);const n=X(),{mode:r}=n.palette,o=()=>{const l=s.reduce((u,i)=>{const c=new Date(ge(i.timestamp)),d=c.getFullYear(),h=c.getMonth(),g=c.getDate(),y=`${d}-${h+1}-${g}`;return u[y]||(u[y]={date:y,users:[]}),u[y].users.push(i),u},{});return Object.values(l)};return t.jsx(Pe,{fullWidth:!0,anchor:"bottom",open:!!s,onClose:()=>e(!1),children:t.jsxs(I,{className:" rounded-l-md rounded-r-md ",children:[t.jsx(T,{sx:{p:1},variant:"h6",children:"People who have seen"}),t.jsx("div",{className:"flex flex-col p-2",children:o().map(l=>{const u=new Date(l.date).getTime(),i=gt(u);return t.jsxs(I,{children:[t.jsx(T,{variant:"caption",children:i}),l.users.sort((c,d)=>le(c,d,"timestamp","older")).map((c,d)=>t.jsx(Os,{seenPerson:c,mode:r},`seenUser-${c.uid}-${d}`))]},i+"seenUsers")})})]})})},Os=({seenPerson:s,mode:e})=>{var i;const{users:n}=a.useContext(C),[r,o]=a.useState(null),[l,u]=a.useState(!0);return H(s.uid,n,o,u),l?t.jsx("div",{className:"mb-1 w-[275px]",children:t.jsx(Ue,{})}):t.jsxs("div",{className:`${e==="light"?"hover:bg-slate-200":"hover:bg-slate-700"} flex p-2 justify-between items-center w-full rounded-md `,children:[t.jsxs("div",{className:"flex items-center gap-x-1",children:[t.jsx(ne,{image:r==null?void 0:r.image,name:r==null?void 0:r.name,size:"size-9"}),t.jsx("p",{children:((i=r==null?void 0:r.name)==null?void 0:i.length)>20?Oe(r==null?void 0:r.name,20):r==null?void 0:r.name})]}),t.jsx(T,{variant:"caption",children:Be(s.timestamp)})]})},Zs=({reactedBy:s,removeReaction:e,reactedUsers:n,setReactedUsers:r})=>{const{userId:o}=a.useContext(C),l=X(),{mode:u}=l.palette,i=c=>({like:"facebookLike",love:"facebookLove",haha:"facebookHaha",wow:"facebookWow",sad:"facebookSad",angry:"facebookAngry"})[c];return t.jsx(Pe,{fullWidth:!0,open:!!s,onClose:()=>r(null),children:t.jsxs("div",{className:"m-2  rounded-l-md rounded-r-md ",children:[t.jsx(T,{variant:"h6",children:"Reactions"}),t.jsx("div",{className:"flex flex-col p-2  overflow-y-auto",children:s.map((c,d)=>{const h=c.uid===o;return t.jsx(Ps,{mode:u,okToRemove:h,reactedPerson:c,getReactIcon:i,removeReaction:e,close:()=>r(null)},`reactedBy-${c.uid}-${d}`)})})]})})},Ps=({getReactIcon:s,reactedPerson:e,okToRemove:n,close:r,removeReaction:o,mode:l})=>{const{users:u}=a.useContext(C),[i,c]=a.useState(null),[d,h]=a.useState(!0);return H(e.uid,u,c,h),d?t.jsx(Ue,{}):t.jsxs("div",{onClick:()=>{n&&(o(),r())},className:`flex p-2 justify-between items-center ${l==="light"?"hover:bg-slate-100":"hover:bg-slate-700"} ${n?"cursor-pointer":""}`,children:[t.jsxs("div",{className:"flex items-center",children:[t.jsx(ne,{image:i==null?void 0:i.image,name:i==null?void 0:i.name,size:"size-9"}),t.jsxs("p",{className:"ml-[4px]",children:[i==null?void 0:i.name," ",n?t.jsx(T,{variant:"caption",children:"(Tap to remove)"}):""]})]}),t.jsx("img",{className:"w-6 ",src:Ze(s(e.reactionType))})]})},Ne=15,Sn=K.memo(()=>{const{userId:s,users:e}=a.useContext(C),{chatId:n}=it(),[r,o]=a.useState(null),[l,u]=a.useState(!1),i=v(P,"chats",n),[c,d]=a.useState(!0),[h,g]=a.useState(!1),[y,j]=a.useState(null);return a.useEffect(()=>{const D=()=>ce(i,k=>{d(!0),k.exists()?(o({...k.data(),id:k.id}),g(!1)):g(!0),d(!1)},k=>{const $="Error fetching the current chat: "+k.message;console.log($),j($),d(!1)});(async()=>{try{const b=U(i,"members"),k=fe(b,lt("uid","==",s),xe(1));console.log("Checking if a member...");const $=await Le(k);u(!$.empty)}catch(b){console.log(b.message)}})();const w=D();return()=>{w&&w()}},[n,l]),c?t.jsx(ts,{isLoading:c,text:"Loading chat..."}):h?t.jsx(Ae,{text:"No chat available"}):l?y?t.jsx(Ae,{text:y}):t.jsx(Vs,{chatId:n,currentChat:r}):t.jsx(Ae,{text:"You are not a member of this chat room"})}),Vs=({chatId:s,currentChat:e})=>{const{userData:n,users:r,newMessages:o,userId:l,setHeaderTitle:u,openSnackbar:i}=a.useContext(C),[c,d]=a.useState(""),[h,g]=a.useState("chat"),[y,j]=a.useState(null),D=v(P,"chats",s),S=U(D,"messages"),[w,b]=a.useState(null),[k,$]=a.useState(!1),[E,M]=a.useState(!1),[Y,ee]=a.useState(null),[F,_]=a.useState(null),[p,z]=a.useState(null),[L,q]=a.useState(!1),O=U(D,"typingUsers"),re=v(O,l),[G,J]=a.useState(!1),[te,Ve]=a.useState(null),[se,He]=a.useState([]);a.useState([]);const[be,jt]=a.useState([]),[Ws,yt]=a.useState(),[Ge,Dt]=a.useState(null),[Q,we]=a.useState(!1),[bt,wt]=a.useState([]),[We,Ye]=a.useState(null),[ue,Fe]=a.useState(null),[de,qe]=a.useState(null);a.useState(!1);const[Je,Ft]=a.useState(0),[vt,Ct]=a.useState(!0),St=X(),{mode:ve}=St.palette;a.useEffect(()=>{const f=(()=>{const x=It(Gt,"/status"),N=Tt(x,Ut("status"),Lt("online"));return Ot(N,Z=>{Ft(Z.size)})})();return()=>{f&&f()}},[]),a.useEffect(()=>{(async()=>{const f=v(P,"chats",e.id),x=U(f,"members");await ut(x,Ye)})()},[e]),a.useEffect(()=>{u((e==null?void 0:e.name)||"SEA - Chat ")},[]),a.useEffect(()=>{let m;return c.trim()?J(!0):J(!1),m=setTimeout(()=>{J(!1)},3e3),()=>{clearTimeout(m)}},[c]);const Et=async()=>{console.log("I am typing...");try{await ke(re,{timestamp:he()})}catch(m){console.error("Error adding user to typing collection: ",m)}},Qe=async()=>{console.log("I am not typing...");try{await pe(re)}catch(m){console.error("Error removing user from typing collection: ",m)}};a.useEffect(()=>(G?Et():Qe(),()=>{Qe()}),[G]);const Ke=m=>{m.docs.length>0&&(yt(m.docs[0]),Dt(m.docs[m.docs.length-1]));const f=m.docs.map(x=>({id:x.id,...x.data()}));f.length<Ne&&Q&&(Ct(!1),Ce(),we(!1),ae()),He(f.sort((x,N)=>le(x,N,"timestamp")))},Ce=()=>{if(Q)return null;const m=U(v(P,"chats",s),"messages");let f=fe(m,tt("timestamp","desc"),xe(Ne));const x=ce(f,N=>{console.log("Fetching messages..."),Ke(N)});return()=>x()};a.useEffect(()=>{const m=Ce();return()=>{m&&m()}},[s,Q]);const Xe=async m=>{const f=m==="old"?"desc":"asc";if(!Ge)return;const x=fe(S,tt("timestamp",f),Zt(Ge),xe(Ne));console.log("Fetching messages...");const N=await Le(x);Ke(N)};H(F==null?void 0:F.senderId,r,z,()=>{},[F]);const zt=async m=>{const f=new Date().getTime(),x=`chats/${s}/${f}-${n==null?void 0:n.name}-${m==null?void 0:m.name}`,N=$e(st,x);$(!0),M(!0);try{const B=await dt(m,{maxSizeMB:.5,maxWidthOrHeight:1280,useWebWorker:!0}),Z=await ot(N,B),Ee=await ct(Z.ref),ze={name:m.name,path:x,URL:Ee,size:B.size};b(ze),$(!1),M(!1)}catch(B){i(B.message),$(!1),M(!1),console.log(B.message)}},At=async m=>{const f=$e(st,m);await Pt(f),b(null)},et=async()=>{const m=v(U(P,"newMessages"),s);await ke(m,{seenBy:Me(l)})};a.useEffect(()=>{(async()=>{const f=v(U(P,"newMessages"),s);Vt(o,s)||await ie(f,{seenBy:Me(l)})})()},[se]);const Nt=async()=>{try{const m={senderId:l,content:c.trim(),timestamp:he(),image:w||null,reply:F||null,seenBy:[]};M(!0),await Ht(S,m),et(),d(""),b(null),ae(),M(!1),_(null),z(null),J(!1)}catch(m){M(!1),i(m.message),console.log(m.message)}},Se=async()=>{try{const m=v(S,y.id),f={senderId:l,content:c.trim(),editedTime:he(),image:w||null,reply:F||null};M(!0),await ie(m,f),et(),Se&&d(""),b(null),j(null),M(!1),_(null),z(null)}catch(m){M(!1),i(m.message),console.log(m.message)}},kt=m=>{const f=se.filter(x=>x.id!==m);He(f)},$t=async(m,f)=>{const x=v(S,m.id);Q&&kt(m.id),await pe(x)};return a.useEffect(()=>{jt((()=>{if(se.length>0){const f=se.reduce((x,N)=>{const B=new Date(ge(N.timestamp)),Z=B.getFullYear(),Ee=B.getMonth(),ze=B.getDate(),me=`${Z}-${Ee+1}-${ze}`;return x[me]||(x[me]={date:me,messages:[]}),x[me].messages.push(N),x},{});return Object.values(f)}else return})())},[se]),h==="info"?t.jsx(us,{setSubPage:g,currentChat:e,memberCounts:We,setMemberCounts:Ye,members:bt,setMembers:wt,onlineUsers:Je}):t.jsxs(I,{color:"text.primary",className:"",children:[t.jsx(Gs,{}),de&&t.jsx(Zs,{reactedBy:de.reactedBy,removeReaction:de.removeReaction,reactedUsers:de,setReactedUsers:qe}),ue&&t.jsx(Xt,{handleClick:()=>{Fe(null)},messageOption:ue,setMessageOption:Fe,options:ue.options,message:ue,chatId:s,isComment:!1}),Y&&t.jsx(es,{image:Y,setViewingImage:ee}),L&&t.jsx(Ms,{isRulesOpen:L,setIsRulesOpen:q,rules:e==null?void 0:e.rules}),te&&t.jsx(Us,{seenUsers:te,setSeenUsers:Ve}),t.jsx(pt,{pageName:"info",setSubPage:g,currentChat:e,memberCounts:We,onlineUsers:Je}),t.jsxs("div",{id:"message-container",className:"p-2 gap-y-3 mb-[55px]",children:[t.jsx("div",{className:"flex justify-center mb-2",children:t.jsx(_e,{sx:{textTransform:"capitalize",mt:1},variant:"text",size:"small",onClick:async()=>{await Xe("old"),ae(),we(!0)},children:"Older messages"})}),t.jsx(I,{children:be==null?void 0:be.map((m,f)=>{const x=new Date(m.date).getTime(),N=gt(x);return t.jsxs(I,{children:[t.jsx(I,{className:"z-10 sticky top-[70px] flex justify-center",children:t.jsx(T,{sx:{p:"3px",borderRadius:1},bgcolor:"background.default",variant:"caption",children:N})}),m.messages.map((B,Z)=>t.jsx(As,{editMessage:Se,setEditMessageObject:j,deleteMessage:$t,message:B,setMessage:d,setImageObject:b,setViewingImage:ee,setReplyMessage:_,chatId:s,messagesRef:S,groupIndex:f,messageIndex:Z,viewingOldMessages:Q,setSeenUsers:Ve,messages:se,setMessageOption:Fe,setReactedUsers:qe,index:Z},`${Z}-${B.id}`))]},m.date)})}),Q&&vt?t.jsxs("div",{className:"flex gap-x-1 justify-center mt-1 mb-2",children:[t.jsx(_e,{size:"small",sx:{textTransform:"capitalize"},onClick:async()=>{await Xe("new"),Mt()},children:"Newer messages"}),t.jsx(A,{placement:"top",title:"Latest messages",arrow:!0,children:t.jsx(ss,{onClick:()=>{we(!1),ae(),Ce()},size:"small",sx:{position:"fixed",bottom:150,right:20},children:t.jsx(as,{})})})]}):"",t.jsx(Bs,{typingUsersRef:O,viewingOldMessages:Q})]}),t.jsxs(I,{bgcolor:"background.default",className:`fixed ${ve==="light"?"border-t-slate-100":"border-t-slate-700"} z-30 bottom-0 border-t  shadow-t-md right-0 left-0 p-2 min-h-[80px] flex flex-col items-center`,children:[t.jsx("div",{className:"w-full flex justify-between items-center text-sm p-1 pt-0 md:w-2/3 lg:w-1/2",children:t.jsx(_e,{size:"small",sx:{textDecoration:"underline"},onClick:()=>q(!0),className:"text-sm underline text-blue-300",children:"Group Rules"})}),y&&t.jsxs("div",{className:"w-full flex justify-between items-center text-sm p-1 md:w-2/3 lg:w-1/2",children:[t.jsx("p",{children:"Editing a message"}),t.jsx(W,{onClick:()=>{j(null),d(""),b(null),_(null),z(null)},children:t.jsx(nt,{})})]}),F&&t.jsxs("div",{className:"w-full flex justify-between items-center text-sm p-1 md:w-2/3 lg:w-1/2",children:[t.jsxs("div",{className:"flex-1",children:[t.jsxs("p",{className:"font-bold",children:["Reply to ",p==null?void 0:p.name]}),t.jsx("p",{children:Oe(F==null?void 0:F.content,25)})]}),t.jsx(W,{onClick:()=>{_(null),z(null)},children:t.jsx(nt,{})})]}),k&&t.jsx("div",{className:"w-full flex justify-between items-center text-sm p-1 md:w-2/3 lg:w-1/2",children:t.jsx("p",{children:"Uploading image..."})}),w&&t.jsxs("div",{className:"w-full flex justify-between items-center text-sm p-1 md:w-2/3 lg:w-1/2",children:[t.jsxs("div",{className:"flex flex-1 items-center gap-x-1",children:[t.jsx("img",{src:w.URL,className:"h-10 rounded-sm"}),t.jsx("p",{children:w.name})]}),t.jsx("button",{onClick:()=>{At(w.path),b(null)},className:"rounded-full shadow-sm p-1",children:t.jsx("img",{className:"w-6",src:Ze("falseIcon")})})]}),t.jsxs(I,{className:`border ${ve==="light"?"border-t-slate-100":"border-slate-700"} shadow-sm w-full md:w-2/3 lg:w-1/2 p-1 rounded-[12px] flex items-center justify-between `,children:[t.jsx("input",{id:"imageFile",className:"hidden",type:"file",onChange:m=>{zt(m.target.files[0])},accept:"image/*"}),t.jsx(A,{arrow:!0,title:"Upload an image",placement:"top",children:t.jsx("label",{htmlFor:"imageFile",className:"p-1 cursor-pointer rounded-md",children:t.jsx(ns,{sx:{width:28}})})}),t.jsx(Hs,{value:c,setValue:d}),t.jsx(A,{title:"Send",arrow:!0,placement:"top",children:t.jsx(W,{disabled:E,sx:{color:ve==="light"&&"black"},onClick:()=>{!E&&(c.trim()||w)&&(y?Se():Nt())},children:t.jsx(os,{})})})]})]})]})},Hs=K.memo(({value:s,setValue:e})=>t.jsx(ht,{multiline:!0,maxRows:4,fullWidth:!0,sx:{"& .MuiOutlinedInput-root":{"& fieldset":{border:"none"}}},inputProps:{sx:{padding:"5px"},inputMode:"text",autoCorrect:"off",autoCapitalize:"off"},value:s,onChange:n=>e(n.target.value),placeholder:"Type a message..."})),Gs=()=>{Bt("chat-page"),Rt("chat-page")};export{Sn as default};
